<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goals - Personal Growth Diary</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <span class="icon">üìì</span>
                <h2>Growth Diary</h2>
            </div>

            <nav class="sidebar-nav">
                <a href="/dashboard" class="nav-item">
                    <span class="icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="/journal" class="nav-item">
                    <span class="icon">‚úçÔ∏è</span>
                    <span>Journal</span>
                </a>
                <a href="/goals" class="nav-item active">
                    <span class="icon">üéØ</span>
                    <span>Goals</span>
                </a>
                <a href="/todos" class="nav-item">
                    <span class="icon">‚úÖ</span>
                    <span>Todos</span>
                </a>
                <a href="/settings" class="nav-item">
                    <span class="icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <span class="user-name" id="user-name">User</span>
                    <button class="btn btn-ghost btn-sm" onclick="logout()" title="Logout">üö™</button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1>üéØ Goals</h1>
                <p>Set and track your short-term and long-term goals</p>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="btn btn-primary" id="btn-short-term">
                    ‚ûï Short-term Goal
                </button>
                <button class="btn btn-secondary" id="btn-long-term">
                    ‚ûï Long-term Goal
                </button>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" data-filter="">All Goals</div>
                <div class="tab" data-filter="short-term">Short-term</div>
                <div class="tab" data-filter="long-term">Long-term</div>
                <div class="tab" data-filter="completed">Completed</div>
            </div>

            <!-- Goals Container -->
            <div id="goals-container">
                <div class="empty-state">
                    <div class="icon">üéØ</div>
                    <h3>No goals yet</h3>
                    <p>Start your journey by setting your first goal</p>
                </div>
            </div>

            <!-- AI Tips Section -->
            <div class="tips-section" id="goals-tips" style="margin-top: 2rem;">
                <div class="tips-header">
                    <span>üí°</span>
                    <h3>Tips for Achieving Your Goals</h3>
                    <button class="btn btn-ghost btn-sm" onclick="loadGoalTips()" style="margin-left: auto;">Refresh</button>
                </div>
                <div class="tips-content" id="goals-tips-content">
                    Loading tips...
                </div>
            </div>
        </main>
    </div>

    <!-- New/Edit Goal Modal -->
    <div class="modal-overlay" id="goal-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="goal-modal-title">New Goal</h2>
                <button class="modal-close" onclick="closeGoalModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="goal-form">
                    <input type="hidden" id="goal-id">
                    <input type="hidden" id="goal-type">

                    <div class="form-group">
                        <label for="goal-title">Goal Title *</label>
                        <input type="text" id="goal-title" class="form-control" 
                               placeholder="What do you want to achieve?" required>
                    </div>

                    <div class="form-group">
                        <label for="goal-description">Description</label>
                        <textarea id="goal-description" class="form-control" rows="3"
                                  placeholder="Describe your goal in detail..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="goal-target-date">Target Date</label>
                        <input type="date" id="goal-target-date" class="form-control">
                    </div>

                    <div class="form-group" id="milestones-section">
                        <label>Milestones (Break down your goal)</label>
                        <div id="milestones-list"></div>
                        <button type="button" class="btn btn-ghost btn-sm" id="btn-add-milestone"
                                style="margin-top: 0.5rem;">
                            ‚ûï Add Milestone
                        </button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="btn-cancel-goal">Cancel</button>
                <button class="btn btn-primary" id="btn-save-goal">Save Goal</button>
            </div>
        </div>
    </div>

    <!-- Progress Update Modal -->
    <div class="modal-overlay" id="progress-modal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Update Progress</h2>
                <button class="modal-close" id="btn-close-progress">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="progress-goal-id">
                <div class="form-group">
                    <label>Progress: <span id="progress-value">0</span>%</label>
                    <input type="range" id="progress-slider" class="form-control" 
                           min="0" max="100" value="0" 
                           style="width: 100%;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="btn-cancel-progress">Cancel</button>
                <button class="btn btn-primary" id="btn-update-progress">Update</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script src="/js/app.js"></script>
    <script>
        let goals = [];
        let currentFilter = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            loadGoals();
            setupTabs();
            loadGoalTips();
            
            // Attach button event listeners
            document.getElementById('btn-short-term').addEventListener('click', function() {
                openNewGoalModal('short-term');
            });
            document.getElementById('btn-long-term').addEventListener('click', function() {
                openNewGoalModal('long-term');
            });
            
            // Goal modal buttons
            document.getElementById('btn-add-milestone').addEventListener('click', addMilestoneInput);
            document.getElementById('btn-cancel-goal').addEventListener('click', closeGoalModal);
            document.getElementById('btn-save-goal').addEventListener('click', saveGoal);
            
            // Progress modal buttons
            document.getElementById('btn-close-progress').addEventListener('click', closeProgressModal);
            document.getElementById('btn-cancel-progress').addEventListener('click', closeProgressModal);
            document.getElementById('btn-update-progress').addEventListener('click', updateProgress);
            document.getElementById('progress-slider').addEventListener('input', function() {
                document.getElementById('progress-value').textContent = this.value;
            });
        });

        // Setup tabs
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentFilter = tab.dataset.filter;
                    renderGoals();
                });
            });
        }

        // Load goals
        async function loadGoals() {
            try {
                const response = await fetch('/api/goals');
                goals = await response.json();
                renderGoals();
            } catch (error) {
                showToast('Failed to load goals', 'error');
            }
        }

        // Render goals
        function renderGoals() {
            const container = document.getElementById('goals-container');
            
            let filtered = goals;
            if (currentFilter === 'completed') {
                filtered = goals.filter(g => g.status === 'completed');
            } else if (currentFilter) {
                filtered = goals.filter(g => g.goal_type === currentFilter && g.status !== 'completed');
            } else {
                filtered = goals.filter(g => g.status !== 'completed');
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üéØ</div>
                        <h3>No goals found</h3>
                        <p>Create a goal to start tracking your progress</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(goal => `
                <div class="goal-card">
                    <div class="goal-header">
                        <div>
                            <span class="goal-type ${goal.goal_type}">${goal.goal_type}</span>
                            <h3 class="goal-title" style="margin-top: 0.5rem;">${escapeHtml(goal.title)}</h3>
                            ${goal.description ? `<p style="color: var(--text-secondary); margin-top: 0.25rem;">${escapeHtml(goal.description)}</p>` : ''}
                        </div>
                        <div class="todo-actions" style="opacity: 1;">
                            <button class="btn btn-ghost btn-sm" onclick="openProgressModal(${goal.id}, ${goal.progress})" title="Update Progress">üìä</button>
                            <button class="btn btn-ghost btn-sm" onclick="editGoal(${goal.id})" title="Edit">‚úèÔ∏è</button>
                            <button class="btn btn-ghost btn-sm" onclick="deleteGoal(${goal.id})" title="Delete">üóëÔ∏è</button>
                        </div>
                    </div>

                    <div class="goal-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${goal.progress}%"></div>
                        </div>
                        <div class="progress-text">
                            <span>${goal.progress}% complete</span>
                            ${goal.target_date ? `<span>Target: ${formatDate(goal.target_date)}</span>` : ''}
                        </div>
                    </div>

                    ${goal.milestones && goal.milestones.length > 0 ? `
                        <div class="milestones">
                            <h4>Milestones (${goal.completed_milestones}/${goal.total_milestones})</h4>
                            ${goal.milestones.map(m => `
                                <div class="milestone-item ${m.is_completed ? 'completed' : ''}" 
                                     onclick="toggleMilestone(${goal.id}, ${m.id})" style="cursor: pointer;">
                                    <span>${m.is_completed ? '‚úÖ' : '‚¨ú'}</span>
                                    <span>${escapeHtml(m.title)}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    ${goal.status === 'active' && goal.progress === 100 ? `
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-success btn-sm btn-block" onclick="completeGoal(${goal.id})">
                                üéâ Mark as Completed
                            </button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Open modal for new goal
        function openNewGoalModal(type) {
            document.getElementById('goal-modal-title').textContent = `New ${type === 'short-term' ? 'Short-term' : 'Long-term'} Goal`;
            document.getElementById('goal-id').value = '';
            document.getElementById('goal-type').value = type;
            document.getElementById('goal-title').value = '';
            document.getElementById('goal-description').value = '';
            document.getElementById('goal-target-date').value = '';
            document.getElementById('milestones-list').innerHTML = '';
            
            // Add initial milestone inputs
            addMilestoneInput();
            addMilestoneInput();
            
            document.getElementById('goal-modal').classList.add('active');
        }

        // Add milestone input
        function addMilestoneInput(value = '') {
            const list = document.getElementById('milestones-list');
            const div = document.createElement('div');
            div.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
            div.innerHTML = `
                <input type="text" class="form-control milestone-input" placeholder="Milestone..." value="${escapeHtml(value)}">
                <button type="button" class="btn btn-ghost btn-sm" onclick="this.parentElement.remove()">‚úï</button>
            `;
            list.appendChild(div);
        }

        // Edit goal
        async function editGoal(id) {
            try {
                const response = await fetch(`/api/goals/${id}`);
                const goal = await response.json();

                document.getElementById('goal-modal-title').textContent = 'Edit Goal';
                document.getElementById('goal-id').value = goal.id;
                document.getElementById('goal-type').value = goal.goal_type;
                document.getElementById('goal-title').value = goal.title;
                document.getElementById('goal-description').value = goal.description || '';
                document.getElementById('goal-target-date').value = goal.target_date || '';

                const list = document.getElementById('milestones-list');
                list.innerHTML = '';
                if (goal.milestones && goal.milestones.length > 0) {
                    goal.milestones.forEach(m => addMilestoneInput(m.title));
                } else {
                    addMilestoneInput();
                }

                document.getElementById('goal-modal').classList.add('active');
            } catch (error) {
                showToast('Failed to load goal', 'error');
            }
        }

        // Save goal
        async function saveGoal() {
            const id = document.getElementById('goal-id').value;
            const title = document.getElementById('goal-title').value.trim();

            if (!title) {
                showToast('Please enter a goal title', 'warning');
                return;
            }

            const milestones = Array.from(document.querySelectorAll('.milestone-input'))
                .map(input => ({ title: input.value.trim() }))
                .filter(m => m.title);

            const data = {
                title,
                description: document.getElementById('goal-description').value,
                goal_type: document.getElementById('goal-type').value,
                target_date: document.getElementById('goal-target-date').value || null,
                milestones
            };

            try {
                const url = id ? `/api/goals/${id}` : '/api/goals';
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showToast(id ? 'Goal updated!' : 'Goal created!', 'success');
                    closeGoalModal();
                    loadGoals();
                } else {
                    const result = await response.json();
                    showToast(result.error || 'Failed to save goal', 'error');
                }
            } catch (error) {
                showToast('Failed to save goal', 'error');
            }
        }

        // Delete goal
        async function deleteGoal(id) {
            if (!confirm('Are you sure you want to delete this goal?')) return;

            try {
                const response = await fetch(`/api/goals/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showToast('Goal deleted', 'success');
                    loadGoals();
                } else {
                    showToast('Failed to delete goal', 'error');
                }
            } catch (error) {
                showToast('Failed to delete goal', 'error');
            }
        }

        // Toggle milestone
        async function toggleMilestone(goalId, milestoneId) {
            try {
                await fetch(`/api/goals/${goalId}/milestones/${milestoneId}/toggle`, { method: 'PATCH' });
                loadGoals();
            } catch (error) {
                showToast('Failed to update milestone', 'error');
            }
        }

        // Open progress modal
        function openProgressModal(goalId, currentProgress) {
            document.getElementById('progress-goal-id').value = goalId;
            document.getElementById('progress-slider').value = currentProgress;
            document.getElementById('progress-value').textContent = currentProgress;
            document.getElementById('progress-modal').classList.add('active');
        }

        // Update progress
        async function updateProgress() {
            const id = document.getElementById('progress-goal-id').value;
            const progress = parseInt(document.getElementById('progress-slider').value);

            try {
                const response = await fetch(`/api/goals/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ progress })
                });

                if (response.ok) {
                    showToast('Progress updated!', 'success');
                    closeProgressModal();
                    loadGoals();
                } else {
                    showToast('Failed to update progress', 'error');
                }
            } catch (error) {
                showToast('Failed to update progress', 'error');
            }
        }

        // Complete goal
        async function completeGoal(id) {
            try {
                const response = await fetch(`/api/goals/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'completed' })
                });

                if (response.ok) {
                    showToast('üéâ Congratulations! Goal completed!', 'success');
                    loadGoals();
                } else {
                    showToast('Failed to complete goal', 'error');
                }
            } catch (error) {
                showToast('Failed to complete goal', 'error');
            }
        }

        // Close modals
        function closeGoalModal() {
            document.getElementById('goal-modal').classList.remove('active');
        }

        function closeProgressModal() {
            document.getElementById('progress-modal').classList.remove('active');
        }

        // Load goal tips
        async function loadGoalTips() {
            try {
                const activeGoals = goals.filter(g => g.status === 'active');
                
                const response = await fetch('/api/ai/tips', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        context: 'goals', 
                        items: activeGoals.length > 0 ? activeGoals : [{ title: 'General productivity', progress: 0 }]
                    })
                });

                const data = await response.json();
                document.getElementById('goals-tips-content').textContent = data.tips;
            } catch (error) {
                document.getElementById('goals-tips-content').textContent = 
                    "Break your goals into smaller milestones. Celebrate small wins along the way! üéØ";
            }
        }

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
        }
    </script>
</body>
</html>
