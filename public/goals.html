<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goals - Personal Growth Diary</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <span class="icon">üìì</span>
                <h2>Growth Diary</h2>
            </div>

            <nav class="sidebar-nav">
                <a href="/dashboard" class="nav-item">
                    <span class="icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="/journal" class="nav-item">
                    <span class="icon">‚úçÔ∏è</span>
                    <span>Journal</span>
                </a>
                <a href="/goals" class="nav-item active">
                    <span class="icon">üéØ</span>
                    <span>Goals</span>
                </a>
                <a href="/todos" class="nav-item">
                    <span class="icon">‚úÖ</span>
                    <span>Todos</span>
                </a>
                <a href="/settings" class="nav-item">
                    <span class="icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <span class="user-name" id="user-name">User</span>
                    <button class="btn btn-ghost btn-sm" onclick="logout()" title="Logout">üö™</button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1>üéØ Goals</h1>
                <p>Set and track your short-term and long-term goals</p>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="btn btn-primary" id="btn-short-term">
                    ‚ûï Short-term Goal
                </button>
                <button class="btn btn-secondary" id="btn-long-term">
                    ‚ûï Long-term Goal
                </button>
            </div>

            <!-- View Toggle -->
            <div class="view-toggle" style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <button class="btn btn-secondary active" id="btn-list-view">üìã List View</button>
                <button class="btn btn-secondary" id="btn-calendar-view">üìÖ Calendar View</button>
            </div>

            <!-- Tabs -->
            <div class="tabs" id="goals-tabs">
                <div class="tab active" data-filter="">All Goals</div>
                <div class="tab" data-filter="short-term">Short-term</div>
                <div class="tab" data-filter="long-term">Long-term</div>
                <div class="tab" data-filter="completed">Completed</div>
            </div>

            <!-- Goals Container (List View) -->
            <div id="goals-container">
                <div class="empty-state">
                    <div class="icon">üéØ</div>
                    <h3>No goals yet</h3>
                    <p>Start your journey by setting your first goal</p>
                </div>
            </div>

            <!-- Calendar View -->
            <div id="calendar-container" style="display: none;">
                <div class="calendar-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <button class="btn btn-ghost" id="btn-prev-month">‚óÄ Prev</button>
                    <h3 id="calendar-month-year" style="margin: 0;"></h3>
                    <button class="btn btn-ghost" id="btn-next-month">Next ‚ñ∂</button>
                </div>
                <div class="calendar-grid" id="calendar-grid"></div>
                <div class="calendar-legend" style="margin-top: 1rem; display: flex; gap: 1.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                    <span>üü¢ Short-term</span>
                    <span>üîµ Long-term</span>
                    <span>‚úÖ Completed</span>
                </div>
            </div>

            <!-- AI Tips Section -->
            <div class="tips-section" id="goals-tips" style="margin-top: 2rem;">
                <div class="tips-header">
                    <span>üí°</span>
                    <h3>Tips for Achieving Your Goals</h3>
                    <button class="btn btn-ghost btn-sm" onclick="loadGoalTips()" style="margin-left: auto;">Refresh</button>
                </div>
                <div class="tips-content" id="goals-tips-content">
                    Loading tips...
                </div>
            </div>
        </main>
    </div>

    <!-- New/Edit Goal Modal -->
    <div class="modal-overlay" id="goal-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="goal-modal-title">New Goal</h2>
                <button class="modal-close" onclick="closeGoalModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="goal-form">
                    <input type="hidden" id="goal-id">
                    <input type="hidden" id="goal-type">

                    <div class="form-group">
                        <label for="goal-title">Goal Title *</label>
                        <input type="text" id="goal-title" class="form-control" 
                               placeholder="What do you want to achieve?" required>
                    </div>

                    <div class="form-group">
                        <label for="goal-description">Description</label>
                        <textarea id="goal-description" class="form-control" rows="3"
                                  placeholder="Describe your goal in detail..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="goal-target-date">Target Date</label>
                        <input type="date" id="goal-target-date" class="form-control">
                    </div>

                    <div class="form-group" id="milestones-section">
                        <label>Milestones (Break down your goal)</label>
                        <div id="milestones-list"></div>
                        <button type="button" class="btn btn-ghost btn-sm" id="btn-add-milestone"
                                style="margin-top: 0.5rem;">
                            ‚ûï Add Milestone
                        </button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="btn-cancel-goal">Cancel</button>
                <button class="btn btn-primary" id="btn-save-goal">Save Goal</button>
            </div>
        </div>
    </div>

    <!-- Progress Update Modal -->
    <div class="modal-overlay" id="progress-modal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Update Progress</h2>
                <button class="modal-close" id="btn-close-progress">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="progress-goal-id">
                <div class="form-group">
                    <label>Progress: <span id="progress-value">0</span>%</label>
                    <input type="range" id="progress-slider" class="form-control" 
                           min="0" max="100" value="0" 
                           style="width: 100%;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="btn-cancel-progress">Cancel</button>
                <button class="btn btn-primary" id="btn-update-progress">Update</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script src="/js/app.js"></script>
    <script>
        let goals = [];
        let currentFilter = '';
        let currentView = 'list';
        let calendarDate = new Date();

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            loadGoals();
            setupTabs();
            loadGoalTips();
            
            // Attach button event listeners
            document.getElementById('btn-short-term').addEventListener('click', function() {
                openNewGoalModal('short-term');
            });
            document.getElementById('btn-long-term').addEventListener('click', function() {
                openNewGoalModal('long-term');
            });
            
            // Goal modal buttons
            document.getElementById('btn-add-milestone').addEventListener('click', addMilestoneInput);
            document.getElementById('btn-cancel-goal').addEventListener('click', closeGoalModal);
            document.getElementById('btn-save-goal').addEventListener('click', saveGoal);
            
            // Progress modal buttons
            document.getElementById('btn-close-progress').addEventListener('click', closeProgressModal);
            document.getElementById('btn-cancel-progress').addEventListener('click', closeProgressModal);
            document.getElementById('btn-update-progress').addEventListener('click', updateProgress);
            document.getElementById('progress-slider').addEventListener('input', function() {
                document.getElementById('progress-value').textContent = this.value;
            });
            
            // View toggle buttons
            document.getElementById('btn-list-view').addEventListener('click', () => switchView('list'));
            document.getElementById('btn-calendar-view').addEventListener('click', () => switchView('calendar'));
            
            // Calendar navigation
            document.getElementById('btn-prev-month').addEventListener('click', () => navigateMonth(-1));
            document.getElementById('btn-next-month').addEventListener('click', () => navigateMonth(1));
        });

        // Setup tabs
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentFilter = tab.dataset.filter;
                    renderGoals();
                });
            });
        }

        // Load goals
        async function loadGoals() {
            try {
                const response = await fetch('/api/goals');
                goals = await response.json();
                renderGoals();
            } catch (error) {
                showToast('Failed to load goals', 'error');
            }
        }

        // Render goals
        function renderGoals() {
            const container = document.getElementById('goals-container');
            
            let filtered = goals;
            if (currentFilter === 'completed') {
                filtered = goals.filter(g => g.status === 'completed');
            } else if (currentFilter) {
                filtered = goals.filter(g => g.goal_type === currentFilter && g.status !== 'completed');
            } else {
                filtered = goals.filter(g => g.status !== 'completed');
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üéØ</div>
                        <h3>No goals found</h3>
                        <p>Create a goal to start tracking your progress</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(goal => {
                const daysRemaining = goal.target_date ? getDaysRemaining(goal.target_date) : null;
                const daysClass = daysRemaining !== null ? (daysRemaining < 0 ? 'overdue' : daysRemaining <= 7 ? 'urgent' : 'normal') : '';
                
                return `
                <div class="goal-card">
                    <div class="goal-header">
                        <div>
                            <span class="goal-type ${goal.goal_type}">${goal.goal_type}</span>
                            <h3 class="goal-title" style="margin-top: 0.5rem;">${escapeHtml(goal.title)}</h3>
                            ${goal.description ? `<p style="color: var(--text-secondary); margin-top: 0.25rem;">${escapeHtml(goal.description)}</p>` : ''}
                        </div>
                        <div class="todo-actions" style="opacity: 1;">
                            <button class="btn btn-ghost btn-sm" onclick="openProgressModal(${goal.id}, ${goal.progress})" title="Update Progress">üìä</button>
                            <button class="btn btn-ghost btn-sm" onclick="editGoal(${goal.id})" title="Edit">‚úèÔ∏è</button>
                            <button class="btn btn-ghost btn-sm" onclick="deleteGoal(${goal.id})" title="Delete">üóëÔ∏è</button>
                        </div>
                    </div>

                    ${daysRemaining !== null && goal.status !== 'completed' ? `
                        <div class="days-countdown ${daysClass}" style="margin: 0.75rem 0; padding: 0.5rem 0.75rem; border-radius: 8px; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                            <span>${daysRemaining < 0 ? '‚ö†Ô∏è' : daysRemaining <= 7 ? 'üî•' : '‚è∞'}</span>
                            <span>${daysRemaining < 0 ? `${Math.abs(daysRemaining)} days overdue` : daysRemaining === 0 ? 'Due today!' : daysRemaining === 1 ? '1 day remaining' : `${daysRemaining} days remaining`}</span>
                        </div>
                    ` : ''}

                    <div class="goal-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${goal.progress}%"></div>
                        </div>
                        <div class="progress-text">
                            <span>${goal.progress}% complete</span>
                            ${goal.target_date ? `<span>Target: ${formatDate(goal.target_date)}</span>` : ''}
                        </div>
                    </div>

                    ${goal.milestones && goal.milestones.length > 0 ? `
                        <div class="milestones">
                            <h4>Milestones (${goal.completed_milestones}/${goal.total_milestones})</h4>
                            ${goal.milestones.map(m => `
                                <div class="milestone-item ${m.is_completed ? 'completed' : ''}" 
                                     onclick="toggleMilestone(${goal.id}, ${m.id})" style="cursor: pointer;">
                                    <span>${m.is_completed ? '‚úÖ' : '‚¨ú'}</span>
                                    <span>${escapeHtml(m.title)}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    ${goal.status === 'active' && goal.progress === 100 ? `
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-success btn-sm btn-block" onclick="completeGoal(${goal.id})">
                                üéâ Mark as Completed
                            </button>
                        </div>
                    ` : ''}
                </div>
            `}).join('');
        }

        // Open modal for new goal
        function openNewGoalModal(type) {
            document.getElementById('goal-modal-title').textContent = `New ${type === 'short-term' ? 'Short-term' : 'Long-term'} Goal`;
            document.getElementById('goal-id').value = '';
            document.getElementById('goal-type').value = type;
            document.getElementById('goal-title').value = '';
            document.getElementById('goal-description').value = '';
            document.getElementById('goal-target-date').value = '';
            document.getElementById('milestones-list').innerHTML = '';
            
            // Add initial milestone inputs
            addMilestoneInput();
            addMilestoneInput();
            
            document.getElementById('goal-modal').classList.add('active');
        }

        // Add milestone input
        function addMilestoneInput(value = '') {
            const list = document.getElementById('milestones-list');
            const div = document.createElement('div');
            div.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
            div.innerHTML = `
                <input type="text" class="form-control milestone-input" placeholder="Milestone..." value="${escapeHtml(value)}">
                <button type="button" class="btn btn-ghost btn-sm" onclick="this.parentElement.remove()">‚úï</button>
            `;
            list.appendChild(div);
        }

        // Edit goal
        async function editGoal(id) {
            try {
                const response = await fetch(`/api/goals/${id}`);
                const goal = await response.json();

                document.getElementById('goal-modal-title').textContent = 'Edit Goal';
                document.getElementById('goal-id').value = goal.id;
                document.getElementById('goal-type').value = goal.goal_type;
                document.getElementById('goal-title').value = goal.title;
                document.getElementById('goal-description').value = goal.description || '';
                document.getElementById('goal-target-date').value = goal.target_date || '';

                const list = document.getElementById('milestones-list');
                list.innerHTML = '';
                if (goal.milestones && goal.milestones.length > 0) {
                    goal.milestones.forEach(m => addMilestoneInput(m.title));
                } else {
                    addMilestoneInput();
                }

                document.getElementById('goal-modal').classList.add('active');
            } catch (error) {
                showToast('Failed to load goal', 'error');
            }
        }

        // Save goal
        async function saveGoal() {
            const id = document.getElementById('goal-id').value;
            const title = document.getElementById('goal-title').value.trim();

            if (!title) {
                showToast('Please enter a goal title', 'warning');
                return;
            }

            const milestones = Array.from(document.querySelectorAll('.milestone-input'))
                .map(input => ({ title: input.value.trim() }))
                .filter(m => m.title);

            const data = {
                title,
                description: document.getElementById('goal-description').value,
                goal_type: document.getElementById('goal-type').value,
                target_date: document.getElementById('goal-target-date').value || null,
                milestones
            };

            try {
                const url = id ? `/api/goals/${id}` : '/api/goals';
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showToast(id ? 'Goal updated!' : 'Goal created!', 'success');
                    closeGoalModal();
                    loadGoals();
                } else {
                    const result = await response.json();
                    showToast(result.error || 'Failed to save goal', 'error');
                }
            } catch (error) {
                showToast('Failed to save goal', 'error');
            }
        }

        // Delete goal
        async function deleteGoal(id) {
            if (!confirm('Are you sure you want to delete this goal?')) return;

            try {
                const response = await fetch(`/api/goals/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showToast('Goal deleted', 'success');
                    loadGoals();
                } else {
                    showToast('Failed to delete goal', 'error');
                }
            } catch (error) {
                showToast('Failed to delete goal', 'error');
            }
        }

        // Toggle milestone
        async function toggleMilestone(goalId, milestoneId) {
            try {
                await fetch(`/api/goals/${goalId}/milestones/${milestoneId}/toggle`, { method: 'PATCH' });
                loadGoals();
            } catch (error) {
                showToast('Failed to update milestone', 'error');
            }
        }

        // Open progress modal
        function openProgressModal(goalId, currentProgress) {
            document.getElementById('progress-goal-id').value = goalId;
            document.getElementById('progress-slider').value = currentProgress;
            document.getElementById('progress-value').textContent = currentProgress;
            document.getElementById('progress-modal').classList.add('active');
        }

        // Update progress
        async function updateProgress() {
            const id = document.getElementById('progress-goal-id').value;
            const progress = parseInt(document.getElementById('progress-slider').value);

            try {
                const response = await fetch(`/api/goals/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ progress })
                });

                if (response.ok) {
                    showToast('Progress updated!', 'success');
                    closeProgressModal();
                    loadGoals();
                } else {
                    showToast('Failed to update progress', 'error');
                }
            } catch (error) {
                showToast('Failed to update progress', 'error');
            }
        }

        // Complete goal
        async function completeGoal(id) {
            try {
                const response = await fetch(`/api/goals/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'completed' })
                });

                if (response.ok) {
                    showToast('üéâ Congratulations! Goal completed!', 'success');
                    loadGoals();
                } else {
                    showToast('Failed to complete goal', 'error');
                }
            } catch (error) {
                showToast('Failed to complete goal', 'error');
            }
        }

        // Close modals
        function closeGoalModal() {
            document.getElementById('goal-modal').classList.remove('active');
        }

        function closeProgressModal() {
            document.getElementById('progress-modal').classList.remove('active');
        }

        // Load goal tips
        async function loadGoalTips() {
            try {
                const activeGoals = goals.filter(g => g.status === 'active');
                
                const response = await fetch('/api/ai/tips', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        context: 'goals', 
                        items: activeGoals.length > 0 ? activeGoals : [{ title: 'General productivity', progress: 0 }]
                    })
                });

                const data = await response.json();
                document.getElementById('goals-tips-content').textContent = data.tips;
            } catch (error) {
                document.getElementById('goals-tips-content').textContent = 
                    "Break your goals into smaller milestones. Celebrate small wins along the way! üéØ";
            }
        }

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
        }

        // Get days remaining until target date
        function getDaysRemaining(targetDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const target = new Date(targetDate);
            target.setHours(0, 0, 0, 0);
            const diffTime = target - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        // Switch between list and calendar view
        function switchView(view) {
            currentView = view;
            
            // Update button states
            document.getElementById('btn-list-view').classList.toggle('active', view === 'list');
            document.getElementById('btn-calendar-view').classList.toggle('active', view === 'calendar');
            
            // Toggle containers
            document.getElementById('goals-container').style.display = view === 'list' ? 'block' : 'none';
            document.getElementById('goals-tabs').style.display = view === 'list' ? 'flex' : 'none';
            document.getElementById('calendar-container').style.display = view === 'calendar' ? 'block' : 'none';
            
            if (view === 'calendar') {
                renderCalendar();
            }
        }

        // Navigate calendar months
        function navigateMonth(direction) {
            calendarDate.setMonth(calendarDate.getMonth() + direction);
            renderCalendar();
        }

        // Render calendar view
        function renderCalendar() {
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            
            // Update header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendar-month-year').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month and total days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Get goals with target dates in this month
            const monthGoals = goals.filter(g => {
                if (!g.target_date) return false;
                const d = new Date(g.target_date);
                return d.getFullYear() === year && d.getMonth() === month;
            });
            
            // Build calendar grid
            let html = `
                <div class="calendar-weekdays" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; margin-bottom: 0.5rem; text-align: center; font-size: 0.8rem; color: var(--text-muted);">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div class="calendar-days" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem;">
            `;
            
            // Empty cells for days before first day
            for (let i = 0; i < firstDay; i++) {
                html += `<div class="calendar-day empty" style="min-height: 80px;"></div>`;
            }
            
            // Days of the month
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayGoals = monthGoals.filter(g => g.target_date === dateStr);
                const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
                
                html += `
                    <div class="calendar-day" style="min-height: 80px; padding: 0.4rem; border: 1px solid var(--border-color); border-radius: 8px; background: ${isToday ? 'rgba(59, 130, 246, 0.15)' : 'var(--card-bg)'}; ${isToday ? 'border-color: var(--primary);' : ''}">
                        <div style="font-weight: ${isToday ? '700' : '500'}; font-size: 0.85rem; color: ${isToday ? 'var(--primary)' : 'var(--text-primary)'};">${day}</div>
                        <div style="margin-top: 0.25rem; display: flex; flex-direction: column; gap: 0.2rem;">
                            ${dayGoals.map(g => `
                                <div class="calendar-goal" onclick="editGoal(${g.id})" style="font-size: 0.7rem; padding: 0.2rem 0.4rem; border-radius: 4px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background: ${g.status === 'completed' ? 'rgba(34, 197, 94, 0.2)' : g.goal_type === 'short-term' ? 'rgba(34, 197, 94, 0.15)' : 'rgba(59, 130, 246, 0.15)'}; color: ${g.status === 'completed' ? '#22c55e' : g.goal_type === 'short-term' ? '#4ade80' : '#60a5fa'};" title="${escapeHtml(g.title)}">
                                    ${g.status === 'completed' ? '‚úÖ' : g.goal_type === 'short-term' ? 'üü¢' : 'üîµ'} ${escapeHtml(g.title)}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            document.getElementById('calendar-grid').innerHTML = html;
        }
    </script>
</body>
</html>
